
name: UI & API (Cucumber + TestNG) - Split Jobs

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      ui_runner:
        description: UI TestNG Cucumber runner class (e.g. runner.DemoRunner)
        required: false
        default: runner.DemoRunner
      api_runner:
        description: API test runner class (e.g. StepDefinition.APITestRunner)
        required: false
        default: StepDefinition.APITestRunner

concurrency:
  group: tasksdemo-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  api-tests:
    runs-on: ubuntu-latest
    env:
      API_RUNNER: ${{ github.event.inputs.api_runner || 'StepDefinition.APITestRunner' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & run API tests
        working-directory: RestAssured
        run: |
          mvn -B -q clean test \
            -Dtest=${{ env.API_RUNNER }} \
            -DdisableXmlReport=true \
            -Dsurefire.useFile=false

      - name: Prepare API site
        run: |
          rm -rf api-site
          mkdir -p api-site
          if [ -d "RestAssured/target/cucumber-reports" ]; then cp -r RestAssured/target/cucumber-reports/* api-site/; fi
          if [ -f "RestAssured/target/cucumber.json" ]; then cp RestAssured/target/cucumber.json api-site/; fi
          if [ -z "$(ls -A api-site 2>/dev/null)" ]; then echo "<html><body><h3>No API report files found</h3></body></html>" > api-site/index.html; fi

      - name: Upload API site artifact
        uses: actions/upload-artifact@v4
        with:
          name: pages-api-site
          path: api-site
          if-no-files-found: error

  ui-tests:
    runs-on: ubuntu-latest
    env:
      UI_RUNNER: ${{ github.event.inputs.ui_runner || 'runner.DemoRunner' }}
      CHROME_BIN: /usr/bin/google-chrome
      HEADLESS: 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Install Chrome (headless)
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb wget gnupg
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          google-chrome --version

      - name: Sanitize POM
        working-directory: GUIAssessment
        run: |
          python - <<'PY'
          import os
          p = "pom.xml"
          if os.path.exists(p):
              with open(p, "rb") as f: data = f.read()
              bom = b'\xef\xbb\xbf'
              if data.startswith(bom): data = data[len(bom):]
              data = data.lstrip().replace(b'\r\n', b'\n')
              with open(p, "wb") as f: f.write(data)
              print("sanitized", p)
          PY

      - name: Run UI tests
        working-directory: GUIAssessment
        run: |
          mvn -B -q clean test \
            -Dtest=${{ env.UI_RUNNER }} \
            -DdisableXmlReport=true \
            -Dsurefire.useFile=false

      - name: Prepare UI site
        run: |
          rm -rf ui-site
          mkdir -p ui-site
          if [ -d "GUIAssessment/test-output" ]; then cp -r GUIAssessment/test-output/* ui-site/; fi
          if [ -d "GUIAssessment/target/cucumber-reports" ]; then cp -r GUIAssessment/target/cucumber-reports/* ui-site/; fi
          if [ -f "GUIAssessment/target/cucumber.json" ]; then cp GUIAssessment/target/cucumber.json ui-site/; fi
          if [ -z "$(ls -A ui-site 2>/dev/null)" ]; then echo "<html><body><h3>No UI report files found</h3></body></html>" > ui-site/index.html; fi

      - name: Upload UI site artifact
        uses: actions/upload-artifact@v4
        with:
          name: pages-ui-site
          path: ui-site
          if-no-files-found: error

  publish-pages:
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
    needs: [api-tests, ui-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Download API site
        uses: actions/download-artifact@v4
        with:
          name: pages-api-site
          path: combined/api

      - name: Download UI site
        uses: actions/download-artifact@v4
        with:
          name: pages-ui-site
          path: combined/ui

      - name: Build public tree
        run: |
          set -e
          rm -rf public
          mkdir -p public/api public/ui
          if [ -d "combined/api" ]; then cp -r combined/api/* public/api/ || true; fi
          if [ -d "combined/ui" ]; then cp -r combined/ui/* public/ui/ || true; fi
          cat > public/index.html <<'HTML'
          <html>
          <head><meta charset="utf-8"><title>Automation Reports</title></head>
          <body>
            <h2>Automation Reports</h2>
            <ul>
              <li><a hrefndex.htmlAPI reports</a></li>
              <li><a href="./ui/index.htmls</a></li>
            </ul>
          </body>
          </html>
          HTML

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy-report:
    if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
    needs: publish-pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
