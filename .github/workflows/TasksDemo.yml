
name: UI & API (Cucumber + TestNG) - Split Jobs

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      ui_runner:
        description: UI TestNG Cucumber runner class (e.g. runner.DemoRunner)
        required: false
        default: runner.DemoRunner
      api_runner:
        description: API test runner class (e.g. StepDefinition.APITestRunner)
        required: false
        default: StepDefinition.APITestRunner

concurrency:
  group: tasksdemo-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  api-tests:
    name: API tests
    runs-on: ubuntu-latest
    env:
      API_RUNNER: ${{ github.event.inputs.api_runner || 'StepDefinition.APITestRunner' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & run API tests
        working-directory: RestAssured
        run: |
          mvn -B -q clean test \
            -Dtest=${{ env.API_RUNNER }} \
            -DdisableXmlReport=true \
            -Dsurefire.useFile=false

      - name: Prepare API site
        run: |
          rm -rf api-site
          mkdir -p api-site
          if [ -d "RestAssured/target/cucumber-reports" ]; then cp -r RestAssured/target/cucumber-reports/* api-site/; fi
          if [ -f "RestAssured/target/cucumber.json" ]; then cp RestAssured/target/cucumber.json api-site/; fi
          if [ -z "$(ls -A api-site 2>/dev/null)" ]; then echo "<html><body><h3>No API report files found</h3></body></html>" > api-site/index.html; fi

      - name: Upload API site artifact
        uses: actions/upload-artifact@v4
        with:
          name: pages-api-site
          path: api-site
          if-no-files-found: error

  ui-tests:
    name: UI tests
    runs-on: ubuntu-latest
    env:
      UI_RUNNER: ${{ github.event.inputs.ui_runner || 'runner.DemoRunner' }}
      CHROME_BIN: /usr/bin/google-chrome
      HEADLESS: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
